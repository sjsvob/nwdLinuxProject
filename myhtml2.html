<html>
<head>
  <style>
    html, body, #viewDiv {
      background-color: #0e532b;
      color: #ffffff;

      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
      font-size: 16px;
      line-height: 1.5;
    }

    h1 {
      font-size: 24px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px;
    }

    section {
      margin-bottom: 40px;
    }

    input {
      margin-left: 20px;
      margin-bottom: 10px;
      margin-top: 10px;
    }

    .my-div {
      margin-left: 20px;
      margin-bottom: 10px;
    }

    p {
      font-family: verdana;
      font-size: 20px;
      margin-left: 20px;
      margin-bottom: 10px;
    }


    @media (max-width: 767px) {
    .container {
      padding: 20px;
    }
  }

  </style>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>CACI: New Web Dev Tutorial API</title>
  <style>

  </style>
  <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.26/"></script>

  <script>
    function entsub(myform) {
      if (window.event && window.event.keyCode == 13) {
        targetLocation();
        return false;
      }
      else
        return true;
    }

    function traverseJSON(jsondata) {
        console.log(jsondata);
        const data = JSON.parse(jsondata);
        console.log(data.Coordinates.length);
        for (let i = 0; i < data.Coordinates.length; i++) {
          console.log(data.Coordinates[i].Name + "," + data.Coordinates[i].Latitude + "," +data.Coordinates[i].Longitude + ",");
        }
    }

    async function queryChatGPT(prompt) {
      const response = await fetch('https://api.openai.com/v1/engines/text-davinci-003/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer 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'
        },
        body: JSON.stringify({
          prompt: prompt,
          max_tokens: 600, // maximum number of tokens to generate in the response
          temperature: 0.7 // controls the creativity of the generated text, higher values lead to more creative but less accurate responses
        })
      });
      const data = await response.json();
      return "{"+data.choices[0].text.trim()+"}";
    }

    function targetLocation() {

      const myIntroDiv = document.getElementById('myIntro');
      myIntroDiv.style.display = 'none';

      const myQuestionDiv = document.getElementById("myQuestion");
      const myTarget = document.getElementById("target").value;
 
      const option1 = document.getElementById('option1');
      const option2 = document.getElementById('option2');
      const option3 = document.getElementById('option3');

      var myPrefixQuestion = "";
      if (option1.checked) {
        // Option 1 was selected: single location
        myPrefixQuestion = "in JSON format return a list of Name, Latitude and Longitude of, ";
      } else if (option2.checked) {
        // None of the options were selected
        myPrefixQuestion = "In JSON format provide a list of Name, Latitude and Longitude vertices to describe the area contained by, ";
      }

      const mySuffixQuestion = ", with the coordinates described as ##.####, ##.####, the list should be called Coordinates."
      const myQuestion = myPrefixQuestion + myTarget + mySuffixQuestion;
      myQuestionDiv.textContent = "ChatGPT Query: " + myQuestion;

      const myResultDiv = document.getElementById("myresult");
    
      queryChatGPT(myQuestion).then(response => {
        myResultDiv.textContent =  "ChatGPT Response: " + response;

        if (option1.checked) {
          // Option 1: Location(s) was selected
          const data = JSON.parse(response);
          displayLocation(data.Coordinates,1);
          traverseJSON(response);
        } else if (option2.checked) {
          // Option 2: area was selected
          const data = JSON.parse(response);
          displayLocation(data.Coordinates,2);
          traverseJSON(response);
        }
        
      }).catch(error => {
        myError.textContent =  "ERROR: "+ error;
      });
    }


    function displayLocation(coordinates,userselection) {

      require([
      "esri/config",
      "esri/Map",
      "esri/views/SceneView",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
      "esri/symbols/MarkerSymbol",
      "esri/geometry/Point"
      ], function(esriConfig, Map, SceneView, Graphic, GraphicsLayer, MarkerSymbol, Point) {
          esriConfig.apiKey = "AAPKb4da8dc96512424cab63adaf1dff1bb2bEVkZ_E0bw4f4CB5LjvRIzKaUxK5atdIXcsbp_4qJRWOTwNmqRxW07Ir_D58NFQt";
          const map = new Map({
          basemap: "arcgis-topographic", //Basemap layer service
          ground: "world-elevation", //Elevation service
        });
      
      const view = new SceneView({
        container: "viewDiv",
        map: map,
        camera: {
          position: {
            x: coordinates[0].Longitude, //Longitude
            y: coordinates[0].Latitude-.03, //Latitude
            z: 2000 //Meters
          },
          tilt: 55
        }
        });

      const graphicsLayer = new GraphicsLayer();
      map.add(graphicsLayer);

      if (userselection==1) {
        const simpleMarkerSymbol = {
          type: "simple-marker",
          color: [226, 119, 40],  // Orange
          outline: {
              color: [255, 255, 255], // White
              width: 1
        }};
        
        for (var i = 0; i < coordinates.length; i++) {
          const point = {
            type: "point",
            longitude: coordinates[i].Longitude, //Longitude
            latitude: coordinates[i].Latitude, //Latitude
          };

          const pointGraphic = new Graphic({
              geometry: point,
              symbol: simpleMarkerSymbol
            });

          graphicsLayer.add(pointGraphic);
        }

      }

      if (userselection==2) {
        const polygon = {
            type: "polygon",
            rings: []
        };

        for (var i = 0; i < coordinates.length; i++) {
          polygon.rings.push([coordinates[i].Longitude,coordinates[i].Latitude]);
        }

        const simpleFillSymbol = {
            type: "simple-fill",
            color: [227, 139, 79, 0.8],  // Orange, opacity 80%
            outline: {
                color: [255, 255, 255],
                width: 1
            }
        };

        const polygonGraphic = new Graphic({
            geometry: polygon,
            symbol: simpleFillSymbol,

        });
        graphicsLayer.add(polygonGraphic);
      }


      });
    };

  </script>
  
  
</head>
<body>
  

  <div class="my-div"> 
    <h1>Stephen J Svoboda - New Web Dev Training - API Exercise</h1>
  </div>
  <div id="myIntro" class="my-div">
    <P>
    Welcome to Stephen J Svoboda's artificial intelligence (AI) enabled geospatial target locator.<br>
    Special thanks to CACI for allowing me to develop it during my New Web Dev Training.<br>
    Text is processed using the natural language processor ChatGPT. <br>
    Geospatial data is provided via ArcGis.<br>
    <br>
    Enter a textual description of the location you wish to target.<br>
    </P>
  </div>

  <div id="myFormDiv" class="my-div">
    <form id="myForm">
      <input type="text" id="target" name="target" onkeypress="return entsub(this.form)"> 
      <button type="button" onclick="targetLocation()">SUBMIT</button> 
      <label>
        <input type="radio" name="option" value="Locations" id="option1" checked>
          Location(s)
      </label>
      <label>
        <input type="radio" name="option" value="Area" id="option2" >
          Area
      </label>


    </form> 
  </div>

  <div id="myQuestion" class="my-div"></div>
  <div id="myresult" class="my-div"></div>
  <div id="myError" class="my-div"></div>
 
  <div id="viewDiv"></div>

</body>
</html>

