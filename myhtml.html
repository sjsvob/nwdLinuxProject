<html>
<head>
  <style>
    html, body, #viewDiv {
      background-color: #0e532b;
      color: #ffffff;

      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
      font-size: 16px;
      line-height: 1.5;
    }

    h1 {
      font-size: 24px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px;
    }

    section {
      margin-bottom: 40px;
    }

    input {
      margin-left: 20px;
      margin-bottom: 10px;
      margin-top: 10px;
    }

    .my-div {
      margin-left: 20px;
      margin-bottom: 10px;
    }

    p {
      font-family: verdana;
      font-size: 20px;
      margin-left: 20px;
      margin-bottom: 10px;
    }


    @media (max-width: 767px) {
    .container {
      padding: 20px;
    }
  }

  </style>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>CACI: New Web Dev Tutorial API</title>
  <style>

  </style>
  <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.26/"></script>

  <script>
    function entsub(myform) {
      if (window.event && window.event.keyCode == 13) {
        targetLocation();
        return false;
      }
      else
        return true;
    }

    function extractLatLong(str) {

      // Regular expression to match latitude and longitude values
      const regex = /(-?\d+(\.\d+)?)째?\s*([NS]),?\s*(-?\d+(\.\d+)?)째?\s*([EW])/i;

      // Extract latitude and longitude values from input string
      const match = str.match(regex);

      // If latitude and longitude were found, convert to decimal format
      if (match) {
        const latitude = parseFloat(match[1]) * (match[3].toUpperCase() === 'N' ? 1 : -1);
        const longitude = parseFloat(match[4]) * (match[6].toUpperCase() === 'E' ? 1 : -1);
        return [latitude, longitude];
      }

      // If no latitude and longitude were found, return null
      return null;
    }

    async function queryChatGPT(prompt) {
      const response = await fetch('https://api.openai.com/v1/engines/text-davinci-003/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer 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'
        },
        body: JSON.stringify({
          prompt: prompt,
          max_tokens: 60, // maximum number of tokens to generate in the response
          temperature: 0.7 // controls the creativity of the generated text, higher values lead to more creative but less accurate responses
        })
      });
      const data = await response.json();
      return data.choices[0].text.trim();
    }

    function targetLocation() {

      const myIntroDiv = document.getElementById('myIntro');
      myIntroDiv.style.display = 'none';

      const myQuestionDiv = document.getElementById("myQuestion");
      const myTarget = document.getElementById("target").value;
 
      const myPrefixQuestion = "What is the latitude and longitude of, ";
      const mySuffixQuestion = ", in the following format ##.####째 N/S, ##.####째 E/W"
      const myQuestion = myPrefixQuestion + myTarget + mySuffixQuestion;
      myQuestionDiv.textContent = "ChatGPT Query: " + myQuestion;

      const myResultDiv = document.getElementById("myresult");
    
      queryChatGPT(myQuestion).then(response => {
        myResultDiv.textContent =  "ChatGPT Response: " + response;
        const [latitude, longitude] = extractLatLong(response);
        if (latitude !== null && longitude !== null) {
          displayLocation(latitude,longitude);
        } else {
          myResultDiv.textContent =  "ERROR: A latitude & longitude were not found.";
        }
        
      }).catch(error => {
        myResultDiv.textContent =  "ERROR: ChatGPT was unable to process your request. "+ error;
      });
    }

    function displayLocation(myLat, myLong) {
      require([
      "esri/config",
      "esri/Map",
      "esri/views/SceneView",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
      "esri/symbols/MarkerSymbol",
      "esri/geometry/Point"
      ], function(esriConfig, Map, SceneView, Graphic, GraphicsLayer, MarkerSymbol, Point) {
          esriConfig.apiKey = "AAPKb4da8dc96512424cab63adaf1dff1bb2bEVkZ_E0bw4f4CB5LjvRIzKaUxK5atdIXcsbp_4qJRWOTwNmqRxW07Ir_D58NFQt";
          const map = new Map({
          basemap: "arcgis-topographic", //Basemap layer service
          ground: "world-elevation", //Elevation service
        });
      
      const view = new SceneView({
        container: "viewDiv",
        map: map,
        camera: {
          position: {
            x: myLong, //Longitude
            y: myLat-.03, //Latitude
            z: 2000 //Meters
          },
          tilt: 55
        }
        });

      const graphicsLayer = new GraphicsLayer();
      map.add(graphicsLayer);

      const point = { //Create a point at CACI
          type: "point",
          longitude: myLong, //Longitude
          latitude: myLat, //Latitude
        };

      const simpleMarkerSymbol = {
          type: "simple-marker",
          color: [226, 119, 40],  // Orange
          outline: {
              color: [255, 255, 255], // White
              width: 1
        }};

      const pointGraphic = new Graphic({
          geometry: point,
          symbol: simpleMarkerSymbol
      });
      graphicsLayer.add(pointGraphic);

    });
    

    };

  </script>
  
  
</head>
<body>
  

  <div class="my-div"> 
    <h1>Stephen J Svoboda - New Web Dev Training - API Exercise</h1>
  </div>
  <div id="myIntro" class="my-div">
    <P>
    Welcome to Stephen J Svoboda's artificial intelligence (AI) enabled geospatial target locator.<br>
    Special thanks to CACI for allowing me to develop it during my New Web Dev Training.<br>
    Text is processed using the natural language processor ChatGPT. <br>
    Geospatial data is provided via ArcGis.<br>
    <br>
    Enter a textual description of the location you wish to target.<br>
    </P>
  </div>

  <div id="myFormDiv" class="my-div">
    <form id="myForm">
      <input type="text" id="target" name="target" onkeypress="return entsub(this.form)"> 
      <button type="button" onclick="targetLocation()">SUBMIT</button> 
    </form> 
  </div>

  <div id="myQuestion" class="my-div"></div>
  <div id="myresult" class="my-div"></div>
 
  <div id="viewDiv"></div>

</body>
</html>

